{% extends "layout.html" %}

{% block title %}
BreakFree Buddy
{% endblock %}

{% block main %}
{% if session['user_id'] %}
<input type="hidden" name="csrf_token" value="{{ session['csrf_token'] }}">
{% endif %}
<div class="container py-5 d-flex flex-column align-items-center">
    <h2 class="dashboard-title mb-4 text-center">ðŸ§  BreakFree Buddy</h2>

    <p class="landing-subtitle text-center mb-4" style="max-width: 600px;">
        Talk to BreakFree Buddy whenever you're struggling, tempted, or just need someone to listen.
        This AI helps you reflect, reframe urges, and stay focused on your recovery journey.
    </p>

    <div class="d-flex justify-content-end" id="chat-button-container">
        <button class="btn btn-outline-light btn-sm btn-gamify-outline" id="reset-btn">
            Reset Chat
        </button>
    </div>

    <div id="chat-box" class="card-gamify p-3 mb-3"
        style="width: 100%; max-width: 700px; height: 500px; overflow-y: auto;">

        <div class="mb-3 p-2 rounded ai-chat-bubble me-auto shadow-sm">
            Hello! I'm BreakFree Buddy. I'm here to help you stay focused on your goals. What's on your mind today?
        </div>

    </div>

    <div class="d-flex" style="width: 100%; max-width: 700px;">
        <input type="text" id="user-input" class="form-control form-control-dark" placeholder="Type your message..."
            autocomplete="off" style="flex-grow: 1;">

        <div class="mx-3 d-flex align-items-center"></div>

        <button class="btn btn-gamify send-button-custom" id="send-btn">Send</button>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const sendBtn = document.getElementById("send-btn");
        const userInput = document.getElementById("user-input");
        const chatBox = document.getElementById("chat-box");
        const resetBtn = document.getElementById("reset-btn");

        // --- Message Rendering Function ---
        function appendMessage(sender, message) {
            const msgDiv = document.createElement("div");
            msgDiv.classList.add("mb-3", "p-2", "rounded", "shadow-sm");
            msgDiv.style.maxWidth = "80%";
            msgDiv.style.wordWrap = "break-word";
            msgDiv.style.whiteSpace = "pre-wrap";

            if (sender === "user") {
                msgDiv.classList.add("user-chat-bubble", "text-white", "ms-auto");
                msgDiv.style.textAlign = "right";
            } else {
                msgDiv.classList.add("ai-chat-bubble", "me-auto");
            }

            msgDiv.innerText = message;
            chatBox.appendChild(msgDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // --- CSRF Token Retrieval (Crucial for protected POST routes) ---
        function getCsrfToken() {
            const tokenElement = document.querySelector('input[name="csrf_token"]');
            if (tokenElement) return tokenElement.value;
            return "";
        }

        // --- Reset Chat Logic (New Function) ---
        async function resetChat() {
            if (confirm("Are you sure you want to reset the chat history? This will clear the session context.")) {
                try {
                    // Must send a POST request with the CSRF token to Flask route
                    await fetch("/reset_chat", {
                        method: "POST",
                        headers: { "X-CSRFToken": getCsrfToken() }
                    });

                    // Reload the page to clear the chat box and display the initial message
                    window.location.reload();
                } catch (error) {
                    console.error("Reset failed:", error);
                    alert("Could not reset chat. Check server connection.");
                }
            }
        }


        // --- Send Message Logic ---
        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            appendMessage("user", message);
            userInput.value = "";

            // Add a temporary 'typing' message
            appendMessage("ai", "Typing...");

            const csrfToken = getCsrfToken();

            try {
                const res = await fetch("/get_ai_response", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrfToken
                    },
                    body: JSON.stringify({ message })
                });

                if (!res.ok) {
                    throw new Error(`Server responded with status: ${res.status}`);
                }

                const data = await res.json();
                // Replace the 'Typing...' message with the actual reply
                chatBox.lastChild.innerText = data.reply;
            } catch (err) {
                console.error(err);
                // Update the last message (the 'Typing...' one) with the error
                chatBox.lastChild.innerText = "âš ï¸ Connection error. Check your server, API key, or model status.";
            }

            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // --- Event Listeners ---
        sendBtn.addEventListener("click", sendMessage);
        userInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") sendMessage();
        });
        resetBtn.addEventListener("click", resetChat);
    });
</script>
{% endblock %}